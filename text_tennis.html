<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA9-rtfPTRlLyYUQUbDPSp9suUT9d2oOm4",
        authDomain: "text-tennis.firebaseapp.com",
        databaseURL: "https://text-tennis-default-rtdb.firebaseio.com",
        projectId: "text-tennis",
        storageBucket: "text-tennis.firebasestorage.app",
        messagingSenderId: "713944993535",
        appId: "1:713944993535:web:cdfc029fa75f5defe146ca"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const gameRef = ref(database, 'tennis-game');
    const instructionsElement = document.getElementById('instructions');
    const rollButton = document.getElementById('roll-btn');
    const resetButton = document.getElementById('reset-btn');

    let playerId = null;
    let playerRole = null; // 'player1' or 'player2'

    // Log messages for debugging
    function logMessage(message) {
        console.log(message);
    }

    // Function to assign player roles
    async function assignRole(snapshot) {
        const data = snapshot.val();
        console.log("Current Game Data:", data);

        if (!data || !data.player1) {
            // Assign Player 1
            playerId = Math.random().toString(36).substring(2, 15);
            await set(ref(database, 'tennis-game/player1'), playerId);
            playerRole = 'player1';
            instructionsElement.textContent = "You are Player 1. Waiting for Player 2...";
            console.log("Assigned Player 1:", playerId);
        } else if (!data.player2) {
            // Assign Player 2
            playerId = Math.random().toString(36).substring(2, 15);
            await set(ref(database, 'tennis-game/player2'), playerId);
            playerRole = 'player2';
            instructionsElement.textContent = "You are Player 2. Player 1 will serve!";
            console.log("Assigned Player 2:", playerId);

            // Mark game as ready
            await update(ref(database, 'tennis-game'), { ready: true });
        } else {
            instructionsElement.textContent = "Game is full. Try again later.";
            console.log("Game is full.");
        }
    }

    // Start game when both players are ready
    function startGame(snapshot) {
        const data = snapshot.val();
        console.log("Game Started Data:", data);

        if (data && data.ready) {
            instructionsElement.textContent = playerRole === 'player1' ? "You will serve first!" : "Player 1 will serve!";
            rollButton.disabled = false;
        }
    }

    // Reset game logic
    function resetGame() {
        set(ref(database, 'tennis-game'), null).then(() => {
            instructionsElement.textContent = "Waiting for players to join...";
            console.log("Game reset successfully.");
        }).catch((error) => {
            console.error("Error resetting the game:", error);
        });
    }

    // Listeners
    onValue(gameRef, assignRole);
    onValue(ref(database, 'tennis-game/ready'), startGame);

    // Button Handlers
    resetButton.addEventListener('click', resetGame);
</script>
